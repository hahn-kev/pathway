<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE script:module PUBLIC "-//OpenOffice.org//DTD OfficeDocument 1.0//EN" "module.dtd">
<script:module xmlns:script="http://openoffice.org/2000/script" script:name="Module1" script:language="StarBasic">
&apos;Changed On Jan-07-2013 for TD-3344(Pictures come out in wrong place)
Dim CanSave as Boolean

Sub StartDontForget
On Error GoTo MyError:
	TurnOffNonPrintingCharacters() 
	
	AlingOverlappingImages()
	
	If  Right(Trim(ThisComponent.Title),4) = &quot;.odm&quot; Then
		HideODMVariable()&apos;&lt;-- set exit sub
	End If

	UpdateTOC()
	
	&apos;If IsCoverImageInserted = &quot;true&quot; And Right(Trim(ThisComponent.Title),4) = &quot;.odm&quot; Then
		&apos;SetImageToCoverPage()
	&apos;End If
	
	If CanSave Then
		oDoc = ThisComponent 
		oDoc.store() 
	End If
	
	If Lcase(OutputFormat) &lt;&gt; &quot;odt&quot; And Len(Trim(OutputFormat)) &gt; 0 Then
		ExportToDOC_PDF
	End IF
		
Exit Sub
MyError:	
End Sub


&apos;Update the Table of Content
Sub UpdateTOC
On Error GoTo MyError:
   oDoc = ThisComponent
   oDoc.refresh() 
   oIndexes = oDoc.getDocumentIndexes() 
   oIndex = oIndexes.getByName(&quot;Table of Contents1&quot;) 
   oIndex.update() 
Exit Sub
MyError:

End Sub


&apos;This procedure align Cover page Image
Sub SetImageToCoverPage
	if ThisComponent.getDrawPage().GetCount &gt; 0 Then
		oGraphic  = ThisComponent.getDrawPage().getByIndex(ThisComponent.getDrawPage().GetCount -1)
		oGraphic.AnchorType = com.sun.star.text.TextContentAnchorType.AT_PAGE
	End If
End Sub


Sub HideODMVariable
exit sub

PageCount = TotalPages
ThisComponent.currentController.getViewCursor().jumpToPage(PageCount)


dim document   as object
dim dispatcher as object

document   = ThisComponent.CurrentController.Frame
dispatcher = createUnoService(&quot;com.sun.star.frame.DispatchHelper&quot;)

dim args1(0) as new com.sun.star.beans.PropertyValue
args1(0).Name = &quot;Text&quot;
args1(0).Value = &quot; &quot;

dispatcher.executeDispatch(document, &quot;.uno:InsertText&quot;, &quot;&quot;, 0, args1())

dispatcher.executeDispatch(document, &quot;.uno:SwBackspace&quot;, &quot;&quot;, 0, Array())

end sub



&apos;This procedure turn off non-printing characters
Sub TurnOffNonPrintingCharacters
	dim document   as object
	dim dispatcher as object
	
	document   = ThisComponent.CurrentController.Frame
	dispatcher = createUnoService(&quot;com.sun.star.frame.DispatchHelper&quot;)
	
	dim args1(0) as new com.sun.star.beans.PropertyValue
	args1(0).Name = &quot;ControlCodes&quot;
	args1(0).Value = false
	
	dispatcher.executeDispatch(document, &quot;.uno:ControlCodes&quot;, &quot;&quot;, 0, args1())
end sub

&apos;This procedure align the overlapping images
Sub AlingOverlappingImages 
dim frameCount, lclNo, curHoriPos, nxtHoriPos
oGraphics = ThisComponent.getTextFrames

frameCount = oGraphics.getCount() -1
lclNo = 0
  For i = 0 To oGraphics.getCount() -1 step 1 

    	If frameCount &gt; i Then
	    	oGraphic = oGraphics.getByIndex(i)
	    	curHoriPos = oGraphic.HoriOrientPosition    	
	    	nxt = oGraphics.getByIndex(i + 1)
	    	nxtHoriPos = nxt.HoriOrientPosition 
			If curHoriPos = nxtHoriPos And (curHoriPos + nxtHoriPos) &gt; 0 Then
				lclNo = lclNo + 1
				If lclNo = 1 Then
				 	oGraphic.HoriOrient = 3
				 	nxt.HoriOrient = 2
				elseif lclNo = 2 Then
				 	oGraphic.HoriOrient = 2
				 	nxt.HoriOrient = 1	
				End If
				if lclNo = 3 Then lclNo = 0
				
				CanSave = True
			End If
		End If
  Next    
End Sub
	


&apos;This procedure exports Odt file into Word/PDF based on the OutputFormat in given FilePath
Sub ExportToDOC_PDF
&apos;stardesktop.terminate 
On Error GoTo MyError:
	Dim FilePathWithName,filterType as string
	Dim oSvc as Object
   	oDoc = ThisComponent 
	
	FilePathWithName = FilePath &amp; &quot;.&quot; &amp; OutputFormat
   	fileURL = ConvertToURL(FilePathWithName)
   	
	if Lcase(OutputFormat) = &quot;doc&quot; Then
		filterType = &quot;MS WinWord 6.0&quot; 
	else
		filterType = &quot;writer_pdf_Export&quot;
	End If 
	&apos;msgbox(&quot;start&quot;)
   	oDoc.storeToURL(fileURL, Array(MakePropertyValue(&quot;FilterName&quot;,filterType)) 
	&apos;msgbox(&quot;end&quot;)
	If Lcase(IsPreview) = &quot;false&quot; Then
		oSvc = createUnoService(&quot;com.sun.star.system.SystemShellExecute&quot;) 
		oSvc.execute(FilePathWithName, &quot;&quot;, 0) 
	End If
		&apos;msgbox(&quot;dispose&quot;)
	oDoc.dispose()
			&apos;msgbox(&quot;disposeEnd&quot;)
Exit Sub
MyError:
&apos;msgbox(&quot;hi&quot;)
End Sub

&apos;This function sets the Property Value as Word or PDF
Function MakePropertyValue( Optional cName As String, Optional uValue ) As com.sun.star.beans.PropertyValue 
   Dim oPropertyValue As New com.sun.star.beans.PropertyValue 
   If Not IsMissing( cName ) Then 
      oPropertyValue.Name = cName 
   EndIf 
   If Not IsMissing( uValue ) Then 
      oPropertyValue.Value = uValue 
   EndIf 
   MakePropertyValue() = oPropertyValue 
End Function 




</script:module>